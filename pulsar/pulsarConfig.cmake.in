# Modules are created without a prefix
set(CMAKE_SHARED_MODULE_PREFIX "")

# Find the dependencies for pulsar
# Add the install path for pulsar to the search path
set(PULSAR_EXTERNAL_DIR "${CMAKE_CURRENT_LIST_DIR}/external")
list(APPEND CMAKE_PREFIX_PATH "${PULSAR_EXTERNAL_DIR}/pybind11")
list(APPEND CMAKE_PREFIX_PATH "${PULSAR_EXTERNAL_DIR}/memwatch")
list(APPEND CMAKE_PREFIX_PATH "${PULSAR_EXTERNAL_DIR}/libtaskforce")
list(APPEND CMAKE_PREFIX_PATH "${PULSAR_EXTERNAL_DIR}/bphash")

# And the find macros
list(APPEND CMAKE_MODULE_PATH "${PULSAR_EXTERNAL_DIR}/cmake")


# Find external projects
find_package(Eigen3 REQUIRED)
find_package(memwatch REQUIRED)
find_package(pybind11 REQUIRED)
find_package(bphash REQUIRED)
find_package(libtaskforce REQUIRED)


# Create the target to link against
add_library(pulsar INTERFACE)

# Required options
target_compile_options(pulsar INTERFACE "-std=c++11")
target_compile_options(pulsar INTERFACE @OpenMP_CXX_FLAGS@)

# pulsar-core uses restrict in a few places (as RESTRICT). So 
# modules compiled against the core headers need to have that in
# their compiler options
if("${CMAKE_CXX_COMPILER_ID}" MATCHES "Intel")
    target_compile_options(pulsar INTERFACE "-restrict;-DRESTRICT=restrict")
elseif("${CMAKE_CXX_COMPILER_ID}" MATCHES "GNU")
    target_compile_options(pulsar INTERFACE "-DRESTRICT=__restrict__")
endif()


#######################################
# Add the various include directories
#######################################
# Main pulsar headers
target_include_directories(pulsar INTERFACE ${CMAKE_CURRENT_LIST_DIR}/include)

# Main dependencies (mark as system includes)
list(APPEND PULSAR_CXX_INCLUDE  ${EIGEN3_INCLUDE_DIR})
list(APPEND PULSAR_CXX_INCLUDES @MPI_CXX_INCLUDE_PATH@)
list(APPEND PULSAR_CXX_INCLUDES @PULSAR_CORE_PYTHON_INCLUDE_DIRS@)
list(APPEND PULSAR_CXX_INCLUDES ${PYBIND11_INCLUDE_DIR})
list(APPEND PULSAR_CXX_INCLUDES ${MEMWATCH_INCLUDE_DIR})
target_include_directories(pulsar SYSTEM INTERFACE ${PULSAR_CXX_INCLUDES})


#######################################
# Add interface libraries to link to
#######################################
target_link_libraries(pulsar INTERFACE bphash libtaskforce)
